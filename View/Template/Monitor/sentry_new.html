{include file="Public/page_header.html"}
{foreach from=$doorList item=door}
<input type="hidden" name="" id="door_real_code_{$door.unqiue_sign}" value="" class="inp"  />
{if $door.door_type eq 0}
	 <div class="rbox">
    	<div class="newbox" id="newbox_{$door.unqiue_sign}">
	    	<div class="hd">
	    		<h2><img src="/Public/images/s1.jpg" alt="" />{$door.door_name}【入口】 <img src="/Public/images/icon_s_n.gif" sign="door_{$door.door_addr}"/></h2>
	    	</div>
	    	<div class="bd">
	    		<table border="0" cellspacing="0" cellpadding="0">
	    			<tr>
	    				<td class="tdw1">读卡：</td>
    					<td class="td2" id="door_code_{$door.unqiue_sign}"></td>
	    			</tr>
	    			<tr>
	    				<td class="tdw1">时间：</td>
    					<td class="td2" id="door_into_time_{$door.unqiue_sign}"></td>
	    			</tr>	
	    			<tr>
	    				<td class="tdw1">车主：</td>
    					<td class="td2" id="door_car_owner_{$door.unqiue_sign}"></td>
	    			</tr>
	    			{if $userInfo.group_id eq 8}
	    			<tr>
	    				<td class="tdw1"></td>
	    				<td><a href="javascript:;" onclick="_manOpenDoor('{$door.door_addr}','{$door.reader_no}',1,'{$door.door_ip}','{$door.brake_no}');"><img src="/Public/images/sgkz.gif" alt="" /></a></td>
	    			</tr>
	    			{/if}
	    		</table>
	    	</div>
	    </div>
    </div>
    <div class="fix h0"></div>
{else}    
    <div class="lbox">
    	<div class="newbox" id="newbox_{$door.unqiue_sign}">
	    	<div class="hd">
	    		<h2><img src="/Public/images/s1.jpg" alt="" />{$door.door_name}【出口】 <img src="/Public/images/icon_s_n.gif" sign="door_{$door.door_addr}"/></h2>
	    	</div>
	    	<div class="bd">
	    		<table border="0" cellspacing="0" cellpadding="0">
	    			<tr>
	    				<td class="tdw1">读卡：</td>
	    				<td class="td2" id="door_code_{$door.unqiue_sign}"></td>
	    				<td class="tdw1">入场：</td>
	    				<td class="td2" id="door_into_time_{$door.unqiue_sign}"></td>
	    				<td class="tdw1">出场：</td>
	    				<td class="td2" id="door_out_time_{$door.unqiue_sign}"></td>
	    			</tr>
	    			<tr>
	    				<td class="tdw1">卡类别：</td>
	    				<td class="td2" id="card_type_{$door.unqiue_sign}"></td>
	    				<td class="tdw1" id="expire_or_money_{$door.unqiue_sign}">有效期：</td>
	    				<td class="td2" id="expire_time_{$door.unqiue_sign}"></td>
	    				<td class="tdw1">剩余天数：</td>
	    				<td class="td2" id="left_days_{$door.unqiue_sign}"></td>
	    			</tr>
	    		</table>
	    		<div class="paybox">
	    			
	    			<form action="1" id="user_form">
    				<table width="100%">
    					<tr>
    						<td width="90">停车时间：</td>
    						<td width="180" id="door_park_time_{$door.unqiue_sign}"></td>
    						<td width="90">应收车费：</td>
    						<td width="120"><span class="num" id="should_money_{$door.unqiue_sign}"></span></td>
    						<td width="90">实收车费：</td>
    						<td colspan="3">
    							<input type="text" value="" class="validate[required,custom[onlyNumberSp]] payinp" id="real_money_{$door.unqiue_sign}"/>
    							{if $userInfo.group_id eq 8}
    								<a href="javascript:;" onclick="_manOpenDoor('{$door.door_addr}','{$door.reader_no}',1,'{$door.door_ip}','{$door.brake_no}');"><img src="/Public/images/sgkz.gif" alt="" /></a>
    							{else}
    								<a href="javascript:;" onclick="manOpenDoor('{$door.door_addr}','{$door.reader_no}',3,'{$door.door_ip}');"><img src="/Public/images/mffx.gif" alt=""/></a>
    								<a href="javascript:;" onclick="manOpenDoor('{$door.door_addr}','{$door.reader_no}',4,'{$door.door_ip}');"><img src="/Public/images/sffx.gif" alt=""/></a>
    							{/if}
							</td>
    					</tr>
    				</table>
    			</form>
	    		</div>
	    	</div>
	    </div>
    </div>
{/if}   
{/foreach}    


<div class="newbox">
    	<div class="hd">
    		<h2><img src="/Public/images/s2.jpg" alt="" />本班统计</h2>
    	</div>
    	<div class="bd">
    		<p class="p1"><span class="bspan">本班应收：<span class="pnum" id="stat_charge"></span> 元</span>     <span class="bspan">本班实收：<span class="pnum" id="stat_real_money"></span> 元</span></p>
    		<p class="p2">总车位数： <strong id="stat_park_count"></strong>   <span class="gline">|</span>   空车位数：<strong id="stat_left_park_count"></strong>   <span class="gline">|</span>   临时卡：<strong id="stat_card_type_counts_1"></strong>   <span class="gline">|</span>   月租卡：<strong id="stat_card_type_counts_3"></strong>   <span class="gline">|</span>   储值卡：<strong id="stat_card_type_counts_2"></strong>   <span class="gline">|</span>   贵宾卡：<strong id="stat_card_type_counts_4"></strong></p>
    	</div>
</div>

<object classid="clsid:F5C7248A-79F7-4866-9836-31227D69570B" codebase="/PSC.cab#version=1,0,0,1" id="px" width="0" height="0" VIEWASTEXT>
</object>



	<object id="ledop" classid="clsid:44A7542F-3AD8-41DD-90DB-7FE2D5F60307" codebase="/LedOPActiveX.CAB#version=1,0,1"
        style="display: none;">
        <param name="pScreenStatusFile" value="c:\\status.ini" />
        <param name="nWidth" value="128" />
        <param name="nHeight" value="64" />
        <param name="nScreenNo" value="1" />
        <param name="LineWidth" value="9" />
    </object>


<script src="/Public/js/json2.js"></script>
<script src="/Public/js/monitor.js?v={$v}"></script>
<script defer="true">
//是否启用共享车位
var isUseShareParking = '{$setting.allow_share_parking_into}';
//是否启用共享车位
var gangtingPage = 1;

var doorJson = {$realDoorListJson};
var port = {$controlData.port};
var door_addr;
var door_type;
var ret;
var controller_data;
var control_sign;
var readerNumber=0;
var ip;
var door_addr_readerNo = {$door_addr_readerNo}
//led json列表
var led_list_json = {$ledListJson};
var ledReleateDoorListJson = {$ledReleateDoorListJson};
{literal}
function checkSn()
{
	if(doorJson)
	{
		$.each(doorJson, function(index, content){ 
			if(!content) return true;
			controller_data=null; 
			readerNumber=0;
			door_addr = parseInt(content.door_addr);
			ip = content.door_ip;
			ret =px.getControlInfo(door_addr,ip,port);//alert(ret);
			var h_ret = ret;
			try{
				if(ret==null){return true;}
				ret = JSON.parse(ret);
				controller_data = ret.Data;
			}catch(e){
				//sendAjax('/Monitor/Ajax/addLog',{'function_name':'getControlInfo','param':'','return':h_ret});
			}
			control_sign = 'door_'+door_addr;
			if(ret.ErrorCode==0)
			{	
				if(exceptionControllerData.hasOwnProperty(content.door_id)) delete exceptionControllerData[content.door_id];
				
				checkTimeInterval=1500;
				$("[sign='"+control_sign+"']").attr('src','/Public/images/icon_r.gif'); 
				//-------------------------------------------------------
				if(controller_data)
				{
					var cardId = controller_data.cardId;
					if(cardId<0) return true;
					var swipeDate = controller_data.swipeDate;
					readerNumber = getReaderNumber(cardId,controller_data.status);
					//--判断该操作是否允许控制-------------------------------------
					var allow_controll = false;
					$.each(door_addr_readerNo, function(index, dar){
						if(dar==(door_addr+'_'+readerNumber)) 
						{
							allow_controll = true;
							return false;
						}
					});
					if(!allow_controll) return true;
					//-频繁刷卡判断--------------------------------------
					if(!checkCard(cardId,door_addr,readerNumber,swipeDate)) return true;
					//-----------------------------------------------
					var postData={'cardCode':cardId,'readerNo':readerNumber,'doorAddr':door_addr};
					var serviceReturnData = sendAjax('/Monitor/Ajax/openDoor',postData);
					
					//卡片控制器删除
					if(typeof(serviceReturnData.data.park)!='undefined')
					{
						var park = serviceReturnData.data.park.split(',');
						var check_status = serviceReturnData.data.check_status;
						var card_info = serviceReturnData.data;
						if (card_info.code.indexOf('-') == -1 && check_status != 0 && (content.park_id == 0 || in_array(content.park_id, park) != -1)) {
							res = px.addOrModifyPrivilege(content.door_addr, ip, port, content.brake_no, card_info.code, card_info.start_time, card_info.end_time, 0, 123456);
							res = JSON.parse(res);
							if (res.ErrorCode != 0)
							{
								res = px.addOrModifyPrivilege(content.door_addr, ip, port, content.brake_no, card_info.code, card_info.start_time, card_info.end_time, 0, 123456);
								res = JSON.parse(res);
							}
							if (res.ErrorCode != 0) {
								alert('删除控制器内卡片信息失败，请重试');
							}
						}
					}

					var _id = '_'+door_addr+'_'+readerNumber;
					if(!checkVariable(serviceReturnData.data.card_id))
					{
						clearInput(_id);
					}
					$('#door_code'+_id).html(cardId);
					$('#door_real_code'+_id).val(cardId);
					var is_open_door = true;
					if(serviceReturnData.code <=0 )//请求服务器 返回开门失败
					{
						is_open_door = false;
						if(serviceReturnData.data.notice.code==-1)
						{
							$('#newbox'+_id).css("background","#FF9999");
						}else if(serviceReturnData.data.notice.code==-2)
						{
							$('#newbox'+_id).css("background","#FFEC8B");
						}else
						{
							$('#newbox'+_id).css("background","");
						}
					}else
					{
						$('#newbox'+_id).css("background","");
					}
					//卡片类型
					if(checkVariable(serviceReturnData.data.card_type_str) && serviceReturnData.data.card_type_str)
					{
						if($('#card_type'+_id).size()>0) $('#card_type'+_id).html(serviceReturnData.data.card_type_str);
					}
					var card_type = 0;
					if(checkVariable(serviceReturnData.data.card_type))
					{
						card_type = serviceReturnData.data.card_type;
						if(card_type == 2)
						{
							$('#expire_or_money'+_id).html('余额：');
							$('#expire_time'+_id).html(serviceReturnData.data.money+"元");
						}else
						{
							$('#expire_or_money'+_id).html('有效期：');
							//有效期
							if(checkVariable(serviceReturnData.data.expire_time))
							{
								if($('#expire_time'+_id).size()>0) $('#expire_time'+_id).html(serviceReturnData.data.expire_time);
							}
						}	
					}
					//剩余天数
					if(checkVariable(serviceReturnData.data.left_days))
					{
						if($('#left_days'+_id).size()>0) $('#left_days'+_id).html(serviceReturnData.data.left_days);
					}
						//---表单赋值-------------------------------
						
						if($('#door_car_owner'+_id).size()>0)
						{
							$('#door_car_owner'+_id).html(serviceReturnData.data.name)
						}
						if(typeof(serviceReturnData.data.sessionData)!='undefined')
						{
								if(typeof(serviceReturnData.data.sessionData.start_time)!='undefined')
								{
									//入场时间
									$('#door_into_time'+_id).html(serviceReturnData.data.sessionData.start_time);
								}else
								{
									$('#door_into_time'+_id).html('');
								}
								
								if(typeof(serviceReturnData.data.sessionData.end_time)!='undefined')
								{
									//入场时间
									$('#door_out_time'+_id).html(serviceReturnData.data.sessionData.end_time);
								}else
								{
									$('#door_out_time'+_id).html('');
								}
								if(typeof(serviceReturnData.data.sessionData.park_time_arr)!='undefined')
								{
									//停车时间
									var p_time = serviceReturnData.data.sessionData.park_time_arr;
									$('#door_park_time'+_id).html('<span class="num">'+p_time.hour+'</span>小时 <span class="num">'+p_time.minute+'</span>分钟');
								}else
								{
									$('#door_park_time'+_id).html('');
								}
								if(typeof(serviceReturnData.data.sessionData.cate_id)!='undefined')
								{
									//车型
									$('#cate_id'+_id).html(serviceReturnData.data.sessionData.cate_id);
								}
								if(typeof(serviceReturnData.data.sessionData.charge)!='undefined')
								{
									//应付
									$('#should_money'+_id).html(serviceReturnData.data.sessionData.charge+'元');
								}else
								{
									$('#should_money'+_id).html('');
								}
						}
						//led显示数据
						showLed(ledReleateDoorListJson,door_addr+'_'+readerNumber,serviceReturnData.data.door_type,serviceReturnData.data);
						if(is_open_door)
						{
							//开门操作
							var physical_door_id = serviceReturnData.data.physical_door_id;
							var returnData = px.openDoor(door_addr,ip,port,physical_door_id);
							//记录日志
							//sendAjax('/Monitor/Ajax/addLog',{'function_name':'openDoor','param':door_addr+"-"+ip+"-"+port+"-"+physical_door_id,'return':returnData});
							returnData = JSON.parse(returnData);
							if(returnData.ErrorCode==0)//控制器返回开门成功
							{
								//清空显示内容
								//clearInput(_id);
							}else
							{
								
							}
						}
						//更新控制器-2013-03-20
						if(isUseShareParking == '1' && checkVariable(serviceReturnData.data.door))
						{
							updateController(serviceReturnData.data);
						}
					//从控制器中删除数据
					px.delRecords(door_addr,ip,port,1);
				}
			}else
			{
				//故障通知
				sendExceptionMessage(content);
				if(checkTimeInterval<20000){
					checkTimeInterval*=2;					
				}
				if(checkTimeInterval>20000){
					//alert('网络异常，请检查后刷新页面！');
				}
				$("[sign='"+control_sign+"']").attr('src','/Public/images/icon_s_e.gif'); 
			}
		}); 
		updateIdleLedShow();//更新空闲led显示
		updateLedToWelcome();
	}	
	//每隔一小时自动刷新页面
	if(getTimestamp() - open_page_time > 3600) window.location.reload();
	setTimeout('checkSn()',checkTimeInterval);
}
var checkTimeInterval=1500;
//页面打开时间
var open_page_time = getTimestamp();
jQuery(document).ready(function(){
	 getStatData();
	//------------
	initLed(led_list_json,parseInt(statData.left_park_count));
	//-----------
	initControllerData(doorJson,port,px);
	//设备检测
	setTimeout('checkSn()',2000);
	//数据统计
	setInterval('getStatData()',30000);
});
{/literal}
</script>
{include file="Public/page_footer.html"}